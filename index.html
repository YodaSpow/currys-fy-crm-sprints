<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Currys CRM FY Sprint Calendar</title>

<link rel="icon" href="https://www.currys.co.uk/on/demandware.static/-/Sites-curryspcworlduk-Library/default/dwac98490e/images/brand-currys-logo.svg" />

<meta name="description" content="Currys CRM FY Sprint Calendar. Click any date to see weeks, sprints and UK bank holidays (England &amp; Wales)." />

<!-- Open Graph / unfurl meta (placeholders; JS will inject FY label) -->
<meta property="og:title" content="Currys CRM FY Sprint Calendar" />
<meta property="og:description" content="Currys CRM FY Sprint Calendar. Click any date to see weeks, sprints and UK bank holidays (England &amp; Wales)." />
<meta property="og:image" content="https://yodaspow.github.io/currys-fy-crm-sprints/assets/og-card-1200x630.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://yodaspow.github.io/currys-fy-crm-sprints/" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Currys CRM FY Sprint Calendar" />
<meta name="twitter:description" content="Currys CRM FY Sprint Calendar. Click any date to see weeks, sprints and UK bank holidays (England &amp; Wales)." />
<meta name="twitter:image" content="https://yodaspow.github.io/currys-fy-crm-sprints/assets/og-card-1200x630.png" />

<style>
  :root{
    --bg:#0b0d12; --card:#141823; --ink:#eef2ff; --muted:#a9b0c0; --grid:#1f2640;
    --chip:#0f1320; --chip-br:#2a3550; --ok:#28d17c; --sel:#ffffff;
    --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.28);
    --band-h:12px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,#0b0d12 0%, #0e1220 60%, #0b0d12 100%);
    color:var(--ink)
  }
  .app{max-width:1720px;margin:0 auto;padding:0 18px 28px}

  .topbar{
    position:sticky;
    top:0;
    z-index:10;
    background:rgba(12,16,28,.8);
    backdrop-filter:blur(10px);
    border-bottom:1px solid #1e2745
  }
  .top-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    padding:14px 4px
  }
  .title h1{margin:0;font-size:24px}
  .title p{margin:4px 0 0;color:var(--muted);font-size:13px}
  .title .subcopy{
    margin:6px 0 0;
    color:rgba(255,255,255,.65);
    font-size:12px;
    border-left:3px solid rgba(255,255,255,.15);
    padding-left:10px;
    line-height:1.5
  }
  .btn{
    background:var(--card);
    border:1px solid var(--chip-br);
    color:var(--ink);
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer
  }
  .btn:hover{border-color:#5b6fa3}

  .info-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    font-weight:600;
    background:#1a2140;
    border:1px solid #2e3a66;
    color:#cfe3ff
  }
  .pill .dot{width:10px;height:10px;border-radius:50%}

  .calendar{margin-top:16px}
  .months{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:16px
  }
  .month{
    background:var(--card);
    border:1px solid var(--grid);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden
  }
  .month h3{
    margin:0;
    padding:12px 14px;
    font-size:18px;
    background:#0f1422;
    border-bottom:1px solid var(--grid);
    display:flex;
    justify-content:space-between;
    align-items:center
  }
  .month h3 .qp{font-weight:600;color:#cfd8ff;font-size:13px;opacity:.95}
  .daynames,.days{display:grid;grid-template-columns:repeat(7,1fr)}
  .daynames div{
    text-align:center;
    font-size:13px;
    color:#b7c0d8;
    padding:8px 0;
    background:#111729;
    border-bottom:1px solid var(--grid)
  }

  .cell{
    border-right:1px solid var(--grid);
    border-bottom:1px solid var(--grid);
    min-height:104px;
    position:relative;
    cursor:pointer;
    overflow:hidden;
    background:#0e1424;
    box-sizing:border-box;
    transition:border-color .12s ease,box-shadow .12s ease
  }
  .cell:nth-child(7n){border-right:none}
  .cell:not(.selected):not(.today):hover{
    z-index:1;
    border:2px solid var(--sel) !important;
  }
  .row-has-stack{min-height:140px;}

  .num{
    position:absolute;
    top:8px;
    right:10px;
    font-size:18px;
    font-weight:700;
    color:#e6ebff;
    text-shadow:0 1px 0 rgba(0,0,0,.4);
    z-index:2
  }

  .cell.today{
    border:3px solid var(--ok) !important;
    z-index:2
  }
  .cell.selected{
    border:3px solid var(--sel-accent, var(--sel)) !important;
    z-index:3
  }
  .cell.selected:hover,
  .cell.today:hover{
    outline:none;
    outline-offset:unset
  }
  .cell.today.selected{z-index:4}

  .sprint-band{
    position:absolute;
    left:0;
    right:0;
    bottom:0;
    height:var(--band-h);
    opacity:.96;
    z-index:0
  }
  .sprint-band.dim::after{
    content:"";
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.28);
    border-top:1px solid rgba(0,0,0,.15)
  }

  .wk-badge{
    position:absolute;
    right:8px;
    bottom:14px;
    font-size:12px;
    padding:3px 8px;
    border-radius:999px;
    background:#0f1324;
    color:#dbe5ff;
    border:2px solid #35426a;
    font-weight:700;
    z-index:1
  }
  .tag-wk{
    position:absolute;
    left:8px;
    top:8px;
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #2a3550;
    background:#0f1320;
    color:#dbe5ff;
    z-index:1
  }

  .special{
    position:relative;
    font-size:12px;
    padding:4px 10px;
    border-radius:11px;
    background:#1a2236;
    color:#d6defa;
    border:1px solid #2a3550;
    z-index:1
  }
  .special.holiday{background:#2a1820;color:#ffd3dd;border-color:#5a2a3a}
  .special.payday{background:#0f2a1a;color:#bff3bf;border-color:#1f5334}
  .special.wk{
    background:#0f1324;
    color:#dbe5ff;
    border:2px solid #35426a;
    font-weight:700;
    padding:3px 9px;
    letter-spacing:.3px;
  }
  .wk-fake{opacity:.95}

  .special-stack{
    position:absolute;
    left:8px;
    bottom:36px;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .row-has-stack .special-stack{
    bottom:46px;
    gap:4px;
  }
  .row-has-stack .special{
    padding:3px 8px;
  }

  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:18px
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    border:1px solid var(--chip-br);
    background:var(--chip);
    padding:6px 10px;
    border-radius:999px;
    font-size:13px;
    color:#dbe5ff
  }
  .dot{width:11px;height:11px;border-radius:50%}

  /* Error state */
  .config-error{
    max-width:960px;
    margin:32px auto 0;
    padding:20px 18px;
    background:#111827;
    border-radius:16px;
    border:1px solid #9f1239;
    box-shadow:var(--shadow);
  }
  .config-error h2{margin:0 0 10px;font-size:20px}
  .config-error p{margin:4px 0;font-size:14px;color:var(--muted)}
  .config-error code{font-family:SFMono-Regular,ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .config-error pre{
    margin-top:12px;
    font-size:12px;
    color:#fecaca;
    background:#020617;
    padding:10px 12px;
    border-radius:8px;
    white-space:pre-wrap;
    word-break:break-word
  }

  @media (max-width:1200px){.months{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="top-inner">
        <div class="title">
          <h1>Currys CRM FY Sprint Calendar</h1>
        <p>Click any date. Weeks are numbered by <strong>Saturday</strong> and shown as <strong>WK</strong>. Sprints = 2-week cadence from a single start Monday. Live bank holidays (England &amp; Wales).</p>
        <p class="subcopy">
          Weeks run <strong>Sunday → Saturday</strong>. The <strong>WK number is shown on Saturday</strong> and applies to that whole week.
        </p>
      </div>
      <div class="info-row" id="topInfo"></div>
      <div><button class="btn" id="btnToday">Today</button></div>
    </div>
  </div>

  <section class="calendar">
    <div class="months" id="months"></div>
    <div class="legend" id="legend"></div>
  </section>
</div>

<script>
let APP_CONFIG=null;
const SPECIALS=new Map();
let __LAST_SELECTED_CELL__=null;
const FAKE_WK_BADGES=new Map();

function pushSpecial(dateISO,special){
  if(!dateISO || !special) return;
  const list=SPECIALS.get(dateISO) || [];
  list.push(special);
  SPECIALS.set(dateISO,list);
}

/* ---------- utils ---------- */
const ymd=d=>{
  const x=new Date(d);
  x.setUTCHours(0,0,0,0);
  return x.toISOString().slice(0,10);
};
const monthName=(y,m)=>new Date(y,m,1).toLocaleString('en-GB',{month:'long',year:'numeric'});

function mondayOf(d){
  const t=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()));
  const wd=t.getUTCDay();
  const diff=(wd===0?-6:1-wd);
  t.setUTCDate(t.getUTCDate()+diff);
  return t;
}
function saturdayOf(d){
  const t=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()));
  const wd=t.getUTCDay();
  const diff=(wd===6?0:(6-wd));
  t.setUTCDate(t.getUTCDate()+diff);
  return t;
}
function sundayOf(d){
  const t=new Date(d);
  t.setUTCDate(t.getUTCDate()+6);
  return t;
}

/* FY label helper, e.g. 2025/26 from fy_start_year */
function fyLabelFromConfig(cfg){
  const y=Number(cfg?.fy_start_year);
  if(!y) return null;
  const next=y+1;
  const suffix=next.toString().slice(2);
  return `${y}/${suffix}`;
}

/* ---------- FY bounds ---------- */
function fyBoundsFromConfig(cfg){
  const y=Number(cfg?.fy_start_year);
  const start=new Date(Date.UTC(y,4,1));
  const end  =new Date(Date.UTC(y+1,3,30));
  return {start,end,startISO:ymd(start),endISO:ymd(end)};
}

/* ---------- anchor Saturday (JSON-driven) ---------- */
function getAnchorSaturday(cfg){
  const rule=(cfg?.tw_anchor_rule||'wk1_saturday').toLowerCase();
  if(rule==='wk1_saturday' && cfg?.weeks?.wk1_saturday){
    return new Date(cfg.weeks.wk1_saturday+'T00:00:00Z');
  }

  console.warn('[Config] Missing weeks.wk1_saturday, falling back to first Saturday on/after 1 May.');
  const may1=new Date(Date.UTC(Number(cfg?.fy_start_year),4,1));
  const wd=may1.getUTCDay();
  const offset=(6-wd+7)%7;
  const sat=new Date(may1);
  sat.setUTCDate(sat.getUTCDate()+offset);
  return sat;
}

/* ---------- build Trading Week table ---------- */
function buildWKTable(cfg){
  const {end}=fyBoundsFromConfig(cfg);
  const anchorSat=getAnchorSaturday(cfg);
  if(!(anchorSat instanceof Date) || isNaN(anchorSat.getTime())){
    throw new Error('Invalid wk1_saturday in config.json');
  }

  const rows=[];
  let wk=1;
  let sat=new Date(anchorSat);

  while(true){
    const mon=mondayOf(sat);
    if(mon > end) break;
    const sun=sundayOf(mon);
    rows.push({wk,week_start:ymd(mon),week_end:ymd(sun),saturday:ymd(sat)});
    wk++;
    sat.setUTCDate(sat.getUTCDate()+7);
  }
  return rows;
}

/* ---------- sprint helpers ---------- */
function sprintColours(seed=7){
  const base=[
    '#6ac8ff','#7fd6a6','#ffc27a','#f39bd1',
    '#9ea6ff','#9ee1ff','#b4f0b4','#ffd6a1',
    '#ffb0b0','#c9adff','#98e0cb','#e7ffa3'
  ];
  const map={};
  for(let i=1;i<=30;i++){
    map['Sprint '+i]=base[(i+seed)%base.length];
  }
  return map;
}
const SPRINT_COLOURS=sprintColours();

function resolveFirstSprintStart(cfg){
  const mode=cfg?.sprint?.mode||'by_first_sprint_date';
  if(mode==='by_first_sprint_date') return cfg?.sprint?.first_sprint_start||null;

  if(mode==='by_anchor_wk'){
    const anchor=Number(cfg?.sprint?.anchor_wk||1);
    const row=(window.__WK_TABLE__||[]).find(r=>r.wk===anchor);
    return row?row.week_start:null;
  }
  return null;
}

function sprintIndexAndSpan(weekStartISO,cfg){
  const first=resolveFirstSprintStart(cfg);
  if(!first){
    return {label:'Sprint ?',start:null,end:null,idx:null};
  }
  const lenW=Number(cfg?.sprint?.length_weeks||2);
  const a=new Date(weekStartISO+'T00:00:00Z');
  const b=new Date(first+'T00:00:00Z');
  const diffWeeks=Math.floor((a-b)/(7*24*3600*1000));
  const idx=Math.floor(diffWeeks/lenW)+1;

  const s=new Date(b);
  s.setUTCDate(s.getUTCDate()+(idx-1)*14);
  const e=new Date(s);
  e.setUTCDate(e.getUTCDate()+13);

  return {label:`Sprint ${idx}`,start:s,end:e,idx};
}

/* ---------- local specials (CSV) ---------- */
async function loadLocalSpecials(){
  try{
    const res=await fetch(`./data/specials.csv?_=${Date.now()}`,{cache:'no-store'});
    if(!res.ok) {
      console.warn('[Specials] no specials.csv found');
      return;
    }
    const text=(await res.text()).replace(/^\uFEFF/,''); // strip BOM if present
    const lines=text.split(/\r?\n/).map(l=>l.trim());
    SPECIALS.clear();
    let imported=0;
    let skipped=0;
    for(const line of lines){
      if(line.startsWith('#')) continue;
      if(/^date,type,label/i.test(line)) continue; // header
      if(!line) continue;
      const parts=line.split(',');
      if(parts.length<3) continue;
      const rawDate=parts[0]?.trim();
      const type=parts[1]?.trim();
      const label=parts.slice(2).join(',').trim(); // allow commas in label
      const iso=parseCsvDateToIso(rawDate);
      if(!iso){
        skipped++;
        console.warn('[Specials] skip invalid date', rawDate, 'line:', line);
        continue;
      }
      pushSpecial(iso,{type:type||'note',label:label||''});
      imported++;
    }
    console.info(`[Specials] loaded ${imported} rows from specials.csv (lines=${lines.length}, skipped=${skipped})`, SPECIALS);
  }catch(e){
    console.warn('[Specials] load error:',e.message||e);
  }
}

function parseCsvDateToIso(raw){
  if(!raw) return null;
  const cleaned=raw
    .replace(/\uFEFF/g,'')
    .replace(/[^\d/.-]/g,'')
    .replace(/-/g,'/'); // normalise separators

  const isoMatch=cleaned.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  if(isoMatch) return `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;

  const ukMatch=cleaned.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(ukMatch){
    const [_,d,m,y]=ukMatch;
    const dd=d.padStart(2,'0');
    const mm=m.padStart(2,'0');
    return `${y}-${mm}-${dd}`;
  }
  return null;
}

function SpecialsFor(date){
  return SPECIALS.get(ymd(date))||[];
}

/* ---------- fake day injector (for testing UI density) ---------- */
async function loadFakeDay(cfg){
  try{
    const fd=cfg?.fake_day;
    if(!fd?.enable_live) return;
    const rawDate=fd.date || fd.first_sprint_start;
    const iso=parseCsvDateToIso(rawDate);
    if(!iso) {
      console.warn('[FakeDay] invalid date', rawDate);
      return;
    }
    const wkLabel=fd.wk_label || 'WK XX';
    const holidayLabel=fd.holiday_label || 'Fake Holiday';
    const paydayLabel=fd.payday_label || 'Fake Pay Day';
    if(wkLabel) FAKE_WK_BADGES.set(iso,wkLabel);
    pushSpecial(iso,{type:'holiday',label:holidayLabel});
    pushSpecial(iso,{type:'payday',label:paydayLabel});
    console.info('[FakeDay] injected test specials for', iso);
  }catch(e){
    console.warn('[FakeDay] error:',e.message||e);
  }
}

/* ---------- bank holidays (live) ---------- */
async function loadGovUkBankHolidays(cfg){
  try{
    if(!cfg?.bank_holidays?.enable_live) return;
    const division=cfg?.bank_holidays?.division||'england-and-wales';
    const {startISO,endISO}=fyBoundsFromConfig(cfg);

    const res=await fetch('https://www.gov.uk/bank-holidays.json',{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    const data=await res.json();

    const ev=data?.[division]?.events||[];
    for(const e of ev){
      if(e.date>=startISO && e.date<=endISO){
        pushSpecial(e.date,{type:'holiday',label:e.title});
      }
    }
  }catch(e){
    console.warn('[BH] fetch error:',e.message||e);
  }
}

/* ---------- UI helpers ---------- */
const MONTHS_EL=document.getElementById('months');
const LEGEND_EL=document.getElementById('legend');
const TOPINFO_EL=document.getElementById('topInfo');

function qpForMonthHeader(d){
  const m=d.getUTCMonth();
  const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let q='Q?',p='P?';
  const qp=APP_CONFIG?.quarters_periods;

  if(qp?.p1_is_may){
    const pm=(m+8)%12;
    p='P'+(pm+1);
  }
  if(qp){
    const mon=monthNames[m];
    const has=a=>Array.isArray(a)&&a.includes(mon);
    if(has(qp.q1_months)) q='Q1';
    else if(has(qp.q2_months)) q='Q2';
    else if(has(qp.q3_months)) q='Q3';
    else if(has(qp.q4_months)) q='Q4';
  }
  return `${q}/${p}`;
}

function buildLegend(seen){
  LEGEND_EL.innerHTML='';
  for(const s of [...new Set(seen)]){
    const c=SPRINT_COLOURS[s]||'#8aa2ff';
    const el=document.createElement('div');
    el.className='badge';
    el.innerHTML=`<span class="dot" style="background:${c}"></span>${s}`;
    LEGEND_EL.appendChild(el);
  }
}

function setTopInfo(date,info){
  TOPINFO_EL.innerHTML='';
  const add=html=>{
    const e=document.createElement('div');
    e.className='pill';
    e.innerHTML=html;
    TOPINFO_EL.appendChild(e);
  };

  add(`<strong>${date.toLocaleDateString('en-GB',{
    weekday:'short',day:'2-digit',month:'short',year:'numeric'
  })}</strong>`);

  const mon=mondayOf(date);
  const fri=new Date(mon); fri.setUTCDate(fri.getUTCDate()+4);
  add(`<span>This week (Mon–Fri): ${mon.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})} → ${fri.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})}</span>`);

  if(info){
    const span=sprintIndexAndSpan(info.week_start,APP_CONFIG);
    const colour=SPRINT_COLOURS[span.label]||'#9fb1ff';
    add(`<span class="dot" style="background:${colour}"></span><span>${span.label}: ${span.start.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})} → ${span.end.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})}</span>`);

    const sat=saturdayOf(date);
    add(`<strong>WK ${info.wk} (Sat ${sat.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})})</strong>`);
  }
  const specials=SPECIALS.get(ymd(date))||[];
  if(specials.length){
    const labels=specials.map(s=>s.label).filter(Boolean).join(' • ');
    if(labels) add(`<span>${labels}</span>`);
  }
}

/* colour helpers for selection outline */
function hexToRgb(hex){
  const h=hex.replace('#','');
  const b=parseInt(h.length===3?h.split('').map(x=>x+x).join(''):h,16);
  return {r:(b>>16)&255,g:(b>>8)&255,b:b&255};
}
function rgbToHex(r,g,b){
  const to=h=>('0'+h.toString(16)).slice(-2);
  return '#'+to(r)+to(g)+to(b);
}
function lightenTowardWhite(hex,t=0.45){
  try{
    const {r,g,b}=hexToRgb(hex);
    return rgbToHex(
      Math.round(r+(255-r)*t),
      Math.round(g+(255-g)*t)
    );
  }catch(_){
    return hex;
  }
}

/* sprint hover helper: tint all cells in same sprint on hover */
function applySprintHover(label,colour,on){
  if(!label || !colour) return;
  let rgb;
  try{
    rgb=hexToRgb(colour);
  }catch(_){
    return;
  }
  const overlay=`inset 0 0 0 9999px rgba(${rgb.r},${rgb.g},${rgb.b},0.16)`;

  const cells=document.querySelectorAll(`.cell[data-sprint-label="${label}"]`);
  cells.forEach(c=>{
    if(on){
      c.dataset.prevBoxShadow=c.style.boxShadow || '';
      c.style.boxShadow=c.dataset.prevBoxShadow
        ? c.dataset.prevBoxShadow+', '+overlay
        : overlay;
    }else{
      if('prevBoxShadow' in c.dataset){
        c.style.boxShadow=c.dataset.prevBoxShadow;
        delete c.dataset.prevBoxShadow;
      }else{
        c.style.boxShadow='';
      }
    }
  });
}

/* ---------- render calendar ---------- */
function renderCalendar(){
  const wkTable=window.__WK_TABLE__||[];
  if(!wkTable.length){
    MONTHS_EL.innerHTML='<div style="padding:16px">No weeks computed.</div>';
    return;
  }

  const today=new Date();
  const firstShow=new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),1));

  const {end}=fyBoundsFromConfig(APP_CONFIG);
  const lastDate=new Date(end);

  MONTHS_EL.innerHTML='';
  const seenSprints=[];
  const monthsRows=[]; // collect row data to sync heights between side-by-side months
  let y=firstShow.getUTCFullYear(), m=firstShow.getUTCMonth();
  const endY=lastDate.getUTCFullYear(), endM=lastDate.getUTCMonth();

  while(y<endY || (y===endY && m<=endM)){
    const first=new Date(Date.UTC(y,m,1));
    const last=new Date(Date.UTC(y,m+1,0));
    const pad=(first.getUTCDay()+6)%7;

    const rowCells=[];
    const rowMax=[];

    const wrap=document.createElement('div');
    wrap.className='month';
    wrap.innerHTML=`
      <h3>${monthName(y,m)} <span class="qp">${qpForMonthHeader(first)}</span></h3>
      <div class="daynames">
        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
      </div>
      <div class="days"></div>`;
    const days=wrap.querySelector('.days');

    for(let i=0;i<pad;i++){
      const d=document.createElement('div');
      d.className='cell';
      d.style.visibility='hidden';
      days.appendChild(d);

      const rowIndex=Math.floor((days.children.length-1)/7);
      rowCells[rowIndex]=rowCells[rowIndex]||[];
      rowCells[rowIndex].push(d);
      rowMax[rowIndex]=rowMax[rowIndex]||0;
    }

    const lastDayOfMonth = last.getUTCDate();
    for(let day=1; day<=lastDayOfMonth; day++){
      const date=new Date(Date.UTC(y,m,day));
      if(date > lastDate) break;

      const sat=saturdayOf(date);
      const isSaturday=(
        sat.getUTCDate()===date.getUTCDate() &&
        sat.getUTCMonth()===date.getUTCMonth() &&
        sat.getUTCFullYear()===date.getUTCFullYear()
      );
      const dayOfWeek=new Date(Date.UTC(y,m,day)).getUTCDay();
      const isWeekend=(dayOfWeek===0||dayOfWeek===6);
      const specialsForDay=SpecialsFor(date);
      const isBH=specialsForDay.some(s=>s.type==='holiday');
      const fakeWk=FAKE_WK_BADGES.get(ymd(date));
      const totalSpecials=specialsForDay.length + (fakeWk?1:0);

      const info=wkTable.find(r=>r.saturday===ymd(sat));

      const cell=document.createElement('div');
      cell.className='cell';
      cell.innerHTML=`<div class="num">${day}</div>`;

      if(ymd(date)===ymd(today)){
        cell.classList.add('today');
      }

      const tag=document.createElement('div');
      tag.className='tag-wk';
      tag.textContent=info ? `WK ${info.wk}` : 'WK —';
      cell.appendChild(tag);

      let sprintLabel=null;
      let sprintColour=null;

      if(info){
        const span=sprintIndexAndSpan(info.week_start,APP_CONFIG);
        sprintLabel=span.label;
        sprintColour=SPRINT_COLOURS[sprintLabel]||'#8aa2ff';
        seenSprints.push(sprintLabel);

        const band=document.createElement('div');
        band.className='sprint-band';
        band.style.background=sprintColour;
        if(isWeekend||isBH) band.classList.add('dim');
        cell.appendChild(band);

        if(isSaturday){
          const b=document.createElement('div');
          b.className='wk-badge';
          b.textContent=`WK ${info.wk}`;
          cell.appendChild(b);
        }
      }

      if(fakeWk && !isSaturday){
        const b=document.createElement('div');
        b.className='wk-badge wk-fake';
        b.textContent=fakeWk;
        cell.appendChild(b);
      }

      if(specialsForDay.length){
        const wrap=document.createElement('div');
        wrap.className='special-stack';
        specialsForDay.forEach(chip=>{
          const sp=document.createElement('div');
          sp.className='special '+(chip.type||'');
          sp.textContent=chip.label||'';
          wrap.appendChild(sp);
        });
        cell.appendChild(wrap);
      }

      const rowIndex=Math.floor((days.children.length)/7);
      rowCells[rowIndex]=rowCells[rowIndex]||[];
      rowCells[rowIndex].push(cell);
      rowMax[rowIndex]=Math.max(rowMax[rowIndex]||0,totalSpecials);

      if(sprintLabel){
        cell.dataset.sprintLabel=sprintLabel;
        cell.dataset.sprintColour=sprintColour;
        cell.addEventListener('mouseenter',()=>{
          applySprintHover(sprintLabel,sprintColour,true);
        });
        cell.addEventListener('mouseleave',()=>{
          applySprintHover(sprintLabel,sprintColour,false);
        });
      }

      cell.addEventListener('click',()=>{
        if(__LAST_SELECTED_CELL__){
          __LAST_SELECTED_CELL__.classList.remove('selected');
          __LAST_SELECTED_CELL__.style.removeProperty('--sel-accent');
        }
        cell.classList.add('selected');
        __LAST_SELECTED_CELL__=cell;

        let selColour='#ffffff';
        if(info){
          if(!sprintColour && sprintLabel){
            sprintColour=SPRINT_COLOURS[sprintLabel]||'#8aa2ff';
          }
          const base=sprintColour;
          if(base) selColour=lightenTowardWhite(base,.45);
        }
        cell.style.setProperty('--sel-accent',selColour);
        setTopInfo(date,info);
      });

      days.appendChild(cell);
    }

    monthsRows.push({rowCells,rowMax});
    MONTHS_EL.appendChild(wrap);
    m++; if(m===12){m=0;y++}
  }

  // sync row height bumps across columns (2-up layout)
  for(let i=0;i<monthsRows.length;i+=2){
    const a=monthsRows[i];
    const b=monthsRows[i+1];
    const maxRows=Math.max(a?.rowMax?.length||0,b?.rowMax?.length||0);
    for(let r=0;r<maxRows;r++){
      const maxCount=Math.max(a?.rowMax?.[r]||0,b?.rowMax?.[r]||0);
      if(maxCount>=3){
        (a?.rowCells?.[r]||[]).forEach(c=>c.classList.add('row-has-stack'));
        (b?.rowCells?.[r]||[]).forEach(c=>c.classList.add('row-has-stack'));
      }
    }
  }

  buildLegend(seenSprints);

  const todayInfo=(window.__WK_TABLE__||[])
    .find(r=>r.saturday===ymd(saturdayOf(new Date())));
  setTopInfo(new Date(),todayInfo);
}

/* ---------- config error UI ---------- */
function renderConfigError(err){
  console.error('[Config] Failed to initialise calendar:', err);

  const app=document.querySelector('.app');
  app.innerHTML = `
    <div class="topbar">
      <div class="top-inner">
        <div class="title">
          <h1>Currys FY Sprint Calendar</h1>
          <p style="color:var(--muted)">
            Configuration error — unable to load <code>data/config.json</code>.
          </p>
        </div>
      </div>
    </div>
    <section class="calendar">
      <div class="config-error">
        <h2>Configuration error</h2>
        <p>The calendar could not read <code>data/config.json</code>.</p>
        <p>Make sure you are serving this folder over HTTP
           (for example with <code>python -m http.server</code>), and that
           <code>data/config.json</code> is valid JSON. Then reload.</p>
        <pre>${(err && err.stack) ? err.stack : (err && err.message) ? err.message : String(err)}</pre>
      </div>
    </section>
  `;
}

/* ---------- meta/title wiring ---------- */
function applyFyMetaFromConfig(cfg){
  const fyLabel=fyLabelFromConfig(cfg);
  if(!fyLabel) return;

  const fullTitle=`Currys CRM FY Sprint Calendar — ${fyLabel}`;

  document.title=fullTitle;

  const h1=document.querySelector('.title h1');
  if(h1){
    h1.textContent=fullTitle;
  }

  const ogTitle=document.querySelector('meta[property="og:title"]');
  if(ogTitle){
    ogTitle.setAttribute('content',fullTitle);
  }

  const descBase=`Currys ${fyLabel} financial year sprint calendar. Click any date to see weeks, sprints and UK bank holidays (England & Wales).`;

  const metaDesc=document.querySelector('meta[name="description"]');
  if(metaDesc){
    metaDesc.setAttribute('content',descBase);
  }
  const ogDesc=document.querySelector('meta[property="og:description"]');
  if(ogDesc){
    ogDesc.setAttribute('content',descBase);
  }

  // Dynamic OG/Twitter image with Movable Ink years param
  const yearsParam=encodeURIComponent(fyLabel);
  const ogImgUrl=`https://email.images.currys.co.uk/p/rp/f1176bedefb9449d.png?mi_u=nic&years=${yearsParam}`;
  const ogImg=document.querySelector('meta[property="og:image"]');
  if(ogImg) ogImg.setAttribute('content',ogImgUrl);
  const twImg=document.querySelector('meta[name="twitter:image"]');
  if(twImg) twImg.setAttribute('content',ogImgUrl);
}

/* ---------- boot ---------- */
async function boot(){
  try{
    const res=await fetch('./data/config.json',{cache:'no-store'});
    if(!res.ok){
      throw new Error(`HTTP ${res.status} loading data/config.json`);
    }
    APP_CONFIG=await res.json();

    applyFyMetaFromConfig(APP_CONFIG);

    window.__WK_TABLE__=buildWKTable(APP_CONFIG);
    await loadLocalSpecials();
    await loadFakeDay(APP_CONFIG);
    await loadGovUkBankHolidays(APP_CONFIG);
    renderCalendar();

    const btnToday=document.getElementById('btnToday');
    if(btnToday){
      btnToday.addEventListener('click',()=>{
        if(__LAST_SELECTED_CELL__){
          __LAST_SELECTED_CELL__.classList.remove('selected');
          __LAST_SELECTED_CELL__.style.removeProperty('--sel-accent');
          __LAST_SELECTED_CELL__=null;
        }
        const today=new Date();
        const wkTable=window.__WK_TABLE__||[];
        const info=wkTable.find(r=>r.saturday===ymd(saturdayOf(today)));
        setTopInfo(today,info);

        const headers=[...document.querySelectorAll('.month h3')];
        const target=headers.find(h=>{
          return h.textContent.includes(today.toLocaleString('en-GB',{month:'long'})) &&
                 h.textContent.includes(String(today.getFullYear()));
        });
        target?.scrollIntoView({behavior:'smooth',block:'start'});
      });
    }
  }catch(e){
    renderConfigError(e);
  }
}

boot();
</script>
</body>
</html>
